<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width">
<title>鯖江市駐車場状況 リアルタイムオープンデータ</title>
</head><body>

<h1>鯖江市駐車場状況</h1>

<main id=main></main>

<hr>
駐車場リアルタイムオープンデータ提供: CC BY <a href=https://www.city.sabae.fukui.jp/>鯖江市役所</a>
(<a href=https://data.city.sabae.lg.jp/opendata-list/>データシティ鯖江 オープンデータ一覧</a>)

<script type="module">
import { fetchViaProxy } from "./fetchViaProxy.js";
import { CSV } from "https://js.sabae.cc/CSV.js";
import { createParkingFig } from "./createParkingFig.js";
import { XML } from "https://js.sabae.cc/XML.js";
import { DateTime } from "https://js.sabae.cc/DateTime.js";

const fetchParkingInfo = async () => {
  const url = "https://data.odp.jig.jp/rdf/jp/fukui/sabae/201.rdf";
  const xml = await fetchViaProxy(url);
  const json = XML.toJSON(xml);
  return json;
};

const names = ["嚮陽会館前駐車場", "ふれあい広場駐車場"];
const info = await fetchParkingInfo();
const parking = [];
const lastUpdate = new DateTime().toStringMin();
for (const name of names) {
  const p = info["rdf:RDF"]["jrrk:ParkingFacility"].find(p => p["rdfs:label"]["#text"] == name);
  parking.push({
    name,
    address: p["jrrk:address"]["#text"],
    price: p["schema:price"]["#text"],
    capacity: p["jrrk:capacity"]["#text"],
    lastUpdate,
  });
}

let id = 1;
for (const p of parking) {
  const div = document.createElement("div");
  div.innerHTML = `
    <div class=name>${p.name}</div>
    <div id=fig${id++} class=indicator></div>
    <div class="small address"><b>住所:</b> ${p.address}</div>
    <div class="small price"><b>料金:</b> ${p.price}</div>
    <div class="small capacity"><b>収容台数:</b> ${p.capacity}台</div>
    <div class="small lastUpdate"><b>最終更新日時:</b> ${p.lastUpdate}</div>
  `;
  div.className = "fig";
  main.appendChild(div);
}

const fetchParkingData = async () => {
  const url = "http://mixsoda.io:2048/testtest.csv?from=-6000000";
  //const url = "http://mixsoda.io:2048/testtest.csv?from=-6";
  const csv = await fetchViaProxy(url);
  const data = CSV.toJSON(CSV.decode(csv));
  //console.log(data);
  const iccids = [
    "8981040000001207740",
    "8981040000001207757",
  ];
  const flg_space = [
    0,
    1,
  ];
  const getLast = (iccid, def) => {
    for (let i = data.length - 1; i >= 0; i--) {
      if (data[i].iccid == iccid) {
        return parseInt(data[i].data, 10);
      }
    }
    return def;
  };
  const figs = [fig1, fig2];
  for (let i = 0; i < iccids.length; i++) {
    const fig = figs[i];
    const iccid = iccids[i];
    const last = getLast(iccid, flg_space[i]);
    fig.innerHTML = "";
    fig.appendChild(createParkingFig(last != flg_space[i]));
  }
  return data;
};

await fetchParkingData();
setInterval(async () => {
  await fetchParkingData();
}, 60 * 1000); // 1min

</script>

<style>
body {
  text-align: center;
  font-family: sans-serif;
  margin: 0;
}
h1 {
  margin: 0 0 .2em 0;
  padding: .5em;
  background-color: #77aa77;
  color: white;
  font-size: 5vw;
}
.fig {
  display: inline-block;
  margin: 1em;
}
.fig > div {
  font-size: 130%;
  max-width: 400px;
}
.fig .small {
  font-size: 100%;
}
.fig .indicator {
  margin: 10px;
}
a {
  color: gray !important;
}
</style>

</body></html>
